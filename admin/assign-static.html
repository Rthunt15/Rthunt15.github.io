<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secret Santa — Static Assign (GitHub Pages)</title>
  <style>
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#0f1724;color:#e6eef3;padding:28px}
    .panel{max-width:980px;margin:0 auto;background:rgba(255,255,255,0.02);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    textarea{width:100%;min-height:140px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.01);color:inherit}
    .row{display:flex;gap:12px;margin-top:12px}
    .col{flex:1}
    .btn{background:linear-gradient(90deg,#4fd1c5,#2b87a0);color:#032223;padding:10px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    table{width:100%;margin-top:12px;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
    a.link{color:#7fe8d9}
    .note{color:#9aa6b2;font-size:0.95rem}
    .small{font-size:0.9rem;color:var(--muted,#9aa6b2)}
  </style>
</head>
<body>
  <main class="panel">
    <h2>Assign Secret Santa — Static mode</h2>
    <p class="note">This page runs entirely in your browser and works on GitHub Pages. Provide a list of recipient names (one per line) and a list of submission URLs (one per line). Submission URLs can be absolute (https://...) or relative paths like <code>/submissions/secretsanta_ab12ef34.txt</code>. The tool will fetch each submission to read the submitter's name (used only to avoid giving someone their own submission). Submitter names are NOT shown in the UI.</p>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div>
        <label for="recipients">Recipients (one per line)</label>
        <textarea id="recipients" placeholder="Alice\nBob\nCharlie"></textarea>
      </div>
      <div>
        <label for="submissions">Submission URLs (one per line)</label>
        <textarea id="submissions" placeholder="/submissions/secretsanta_ab12ef34.txt\n/submissions/secretsanta_de56gh78.txt"></textarea>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button id="run" class="btn">Create assignments</button>
      <button id="clear" class="btn" style="background:#223">Clear</button>
      <span id="status" style="margin-left:12px;color:#9aa6b2"></span>
    </div>

    <div id="result"></div>
  </main>

  <script>
    // Utility: shuffle array in-place
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } }

    async function fetchSubmitter(url){
      // ensure absolute url if starts with /
      let fetchUrl = url;
      if (url.startsWith('/')) fetchUrl = window.location.origin + url;
      try{
        const r = await fetch(fetchUrl, {cache:'no-store'});
        if (!r.ok) throw new Error('fetch_failed');
        const txt = await r.text();
        const m = txt.match(/^Name:\s*(.*)$/m);
        const submitter = m ? m[1].trim() : null;
        return {url: fetchUrl, submitter};
      }catch(err){
        return {url: fetchUrl, submitter: null, error: String(err)};
      }
    }

    document.getElementById('run').addEventListener('click', async ()=>{
      const recipTxt = document.getElementById('recipients').value.trim();
      const subsTxt = document.getElementById('submissions').value.trim();
      const status = document.getElementById('status');
      const result = document.getElementById('result');
      result.innerHTML=''; status.textContent='';
      if(!recipTxt) return alert('Enter at least one recipient');
      if(!subsTxt) return alert('Enter at least one submission URL');

      const recipients = recipTxt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const subsList = subsTxt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      if(subsList.length < recipients.length){
        return alert('There are fewer submissions than recipients. Provide at least as many submissions as recipients.');
      }

      status.textContent = 'Fetching submissions...';
      const fetched = await Promise.all(subsList.map(u => fetchSubmitter(u)));
      const failed = fetched.filter(f=>f.error);
      if(failed.length){
        status.textContent = 'Some submissions failed to fetch. Check the URLs and try again.';
        const div = document.createElement('div'); div.className='small'; div.textContent = 'Failed: ' + failed.map(f=>f.url + ' ('+f.error+')').join(', ');
        result.appendChild(div);
        return;
      }

      status.textContent = 'Assigning...';
      // prepare pool of submission objects
      const pool = fetched.map(f=>({url:f.url, submitter: f.submitter}));

      // Attempt randomized derangement: shuffle pool and try to pick first N where no submitter===recipient
      const maxAttempts = 10000;
      let attempt = 0;
      let chosen = null;
      const n = recipients.length;
      while(attempt < maxAttempts){
        attempt++;
        shuffle(pool);
        const pick = pool.slice(0, n);
        let ok = true;
        for(let i=0;i<n;i++){
          const r = recipients[i].toLowerCase();
          const s = pick[i].submitter ? pick[i].submitter.toLowerCase() : null;
          if (s && s === r){ ok=false; break; }
        }
        if (ok){ chosen = pick; break; }
      }

      if(!chosen){
        status.textContent = 'Failed to find a valid assignment; try again or shuffle recipient order.';
        return;
      }

      status.textContent = 'Done';
      // Present mapping (do NOT show submitter names)
      const table = document.createElement('table');
      const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>Recipient</th><th>Assigned file</th></tr>'; table.appendChild(thead);
      const tbody = document.createElement('tbody');
      const assignments = {};
      for(let i=0;i<n;i++){
        const r = recipients[i];
        const s = chosen[i];
        assignments[r] = s.url;
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.textContent = r;
        const td2 = document.createElement('td');
        const a = document.createElement('a'); a.href = s.url; a.textContent = s.url; a.target='_blank'; a.className='link';
        td2.appendChild(a);
        tr.appendChild(td1); tr.appendChild(td2);
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      result.appendChild(table);

      // Add CSV export button
      const exportBtn = document.createElement('button'); exportBtn.textContent='Copy CSV to clipboard'; exportBtn.className='btn'; exportBtn.style.marginTop='12px';
      exportBtn.addEventListener('click', async ()=>{
        const rows = ['Recipient,AssignedFile'];
        for(const r of Object.keys(assignments)) rows.push('"'+r.replace(/"/g,'""')+'","'+assignments[r].replace(/"/g,'""')+'"');
        const csv = rows.join('\n');
        try{
          await navigator.clipboard.writeText(csv);
          alert('CSV copied to clipboard');
        }catch(err){
          // fallback: show textarea
          const ta = document.createElement('textarea'); ta.style.width='100%'; ta.style.height='160px'; ta.textContent=csv; result.appendChild(ta);
        }
      });
      result.appendChild(exportBtn);

    });

    document.getElementById('clear').addEventListener('click', ()=>{ document.getElementById('recipients').value=''; document.getElementById('submissions').value=''; document.getElementById('result').innerHTML=''; document.getElementById('status').textContent=''; });
  </script>
</body>
</html>